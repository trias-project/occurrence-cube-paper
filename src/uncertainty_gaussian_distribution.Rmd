---
title: "Simulations of occurrence cubes"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
bibliography: references.bib
---

```{r setup, include=FALSE}
library(here)
library(knitr)
opts_chunk$set(echo = TRUE,
               warning = FALSE,
               message = FALSE)
opts_knit$set(root.dir = here())

conflicted::conflicts_prefer(dplyr::select())
conflicted::conflicts_prefer(dplyr::filter())

library(sf)
library(tidyverse)
library(ggExtra)
library(mnormt)
```

# Data generation

We create a point with 100 m uncertainty.

```{r}
point_df <- tibble(lat = 183900,
                   long = 64000,
                   coordinateUncertaintyInMeters = 100)
```

# Background

There are multiple ways how the uncertainty of `coordinateUncertaintyInMeters` on GBIF could have been generated. This can for example be uncertainty based on the measurement device but also generated by data aggregation for example with sensitive data.

When coordinate uncertainty comes from different sources or the uncertainty generating process is unknown, it might be save to randomly assign a point within a grid cell according to a uniform distribution within its "uncertainty circle". However, if the researcher knows the coordinate uncertainty of all observations relies on the GPS measurements, a normal distribution might be more relevant (see [GPS Uncertainty](https://harbor.academic.wlu.edu/current-courses/geology-100/daily-schedule/campus-mapping-lab/gps-uncertainty/)). Although it must be recognised that this is not strictly a gaussian process [@specht2020].

This could be parametrised when creating the cube. The user decides which distribution (and parameters to use) with recommendations from our side.

-  `uniform(0, coordinateUncertaintyInMeters)`
   -  no modifiable parameters necessary
   -  each location within the uncertainty circle has an equal probability
   -  useful when there are multiple uncertainty generation processes involved or when the process(es) is (are) unknown 
-  `normal(mu = 0, sigma = coordinateUncertaintyInMeters / qnorm(p))`
   -  `p` can be chosen by the user, default value is 0.975
   -  locations near the center of the uncertainty circle have higher probability then near the edge
   -  there might be multiple reasons for which a normal distribution is more desirable than a uniform distribution that could be argued by the user
      -  e.g. all data come from one project where uncertainty is due to the GPS measuring device

# Visualisation

```{r}
mu <- c(point_df$long, point_df$lat)
var <- (point_df$coordinateUncertaintyInMeters / qnorm(0.975))^2
varcovar <- matrix(c(var, -1, -1, var), nrow = 2)

dat <- rmnorm(10000, mean = mu, varcov = varcovar) %>%
  as_tibble() %>%
  rename(long = V1, lat = V2) %>%
  mutate(density = dmnorm(cbind(long, lat), mean = mu, varcov = varcovar))
```

```{r}
scatter <- dat %>%
  ggplot(aes(x = long, y = lat)) + 
    geom_point(aes(colour = density)) +
    geom_segment(data = point_df, 
               aes(x = long, xend = long + coordinateUncertaintyInMeters, 
                   y = lat, yend = lat),
               linewidth = 1.5, colour = "green") +
    geom_text(aes(y = 183910, x = 64050, label = "100 m"), colour = "green") +
    geom_point(data = point_df, aes(x = long, y = lat), color = "firebrick") +
    stat_ellipse(level = 0.95, linewidth = 1.5, color = "firebrick") +
    coord_fixed() +
    labs(x = "longitude", y = "latitude") +
    theme(legend.position = "")
    

ggMarginal(scatter, type = "histogram")
```

# References
