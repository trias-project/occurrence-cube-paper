---
title: "Simulations of occurrence cubes"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE)

library(sf)
library(tidyverse)

source("src/simulation_functions.R")
```

# Simulate data

First we simulate points.

```{r}
test_points <- sim_points(10, add_points = tibble(lat = 183900, long = 64000,
                          coordinateUncertaintyInMeters = 50))

test_circles <- test_points %>%
  st_buffer(test_points$coordinateUncertaintyInMeters)
```

We create a custom grid around the points.

```{r}
grid_df <- create_grid(500, test_circles)
```

Visualisation:

```{r}
ggplot() +
  geom_sf(data = grid_df) +
  geom_sf(data = test_circles, fill = alpha("white", 0))
```


# Simulate cubes

```{r}
sims <- 1000
```

We simulate `r sims` cubes.

```{r}
final_df <- sim_cubes(sims, test_points, grid_df)
```


## Calculate statistics

```{r}
# Summary statistics
summary_df <- final_df %>%
  group_by(id) %>%
  summarise(mean_n = mean(n),
            sd_n = sd(n),
            median_n = median(n),
            iqr_n = IQR(n))

# Calculate effective number of occurrences
int_grid_circle <- test_circles %>%
  mutate(circle_area = st_area(test_circles),
         point_id = row_number()) %>%
  st_intersection(grid_df)

props <- int_grid_circle %>%
  mutate(area = st_area(int_grid_circle),
         prop = area / circle_area)

summary_grid_props <- props %>%
  st_drop_geometry() %>%
  group_by(id) %>%
  summarise(expected_n = sum(prop)) %>%
  full_join(grid_df, by = join_by(id)) %>%
  st_as_sf() %>%
  mutate(expected_n = ifelse(is.na(expected_n), 0, expected_n))

# Calculate probability of occupancy
occupancy_prob_df <- final_df %>% 
  count(id, n, name = "total") %>%
  group_by(id) %>% 
  mutate(occupancy = ifelse(n == 0, 0, 1)) %>%
  group_by(id, occupancy) %>%
  summarise(n = sum(total)) %>%
  group_by(id) %>%
  mutate(sum = sum(n)) %>%
  ungroup() %>%
  mutate(p = n / sum)

design <-  occupancy_prob_df %>%
  expand(id, occupancy)

occupancy_prob_df <- occupancy_prob_df %>%
  full_join(design, by = join_by(id, occupancy)) %>%
  mutate(across(where(is.numeric), ~ coalesce(.x, 0))) %>%
  group_by(id) %>%
  mutate(sum = sum(n)) %>%
  ungroup() %>%
  filter(occupancy == 1)
```

## Visualise simulations

```{r}
example_cells <- 14:25
```

Example distributions for grid cells `r example_cells`

```{r}
final_df %>% 
  filter(id %in% example_cells) %>%
  mutate(occupancy = ifelse(n == 0, "0", ">1")) %>%
  ggplot(aes(x = n)) + 
    geom_bar(aes(fill = occupancy)) +
    geom_text(data = summary_df %>% filter(id %in% example_cells), 
              aes(x = 3, y = 750, label = paste0("mean: ", mean_n, "\n",
                                                 "sd: ", round(sd_n, 3), "\n",
                                                 "median: ", median_n))) +
    facet_wrap(~id) +
    labs(y = "frequency", x = "number of observations per grid")
```


# Visualise statistics

In total we have `r nrow(test_points)` occurrences.

```{r, fig.height=10}
summary_df %>%
  select(id, mean_n, median_n) %>%
  full_join(summary_grid_props, by = join_by(id)) %>%
  mutate(expected_n_rounded = round(expected_n)) %>%
  pivot_longer(cols = c(mean_n, median_n, expected_n, expected_n_rounded), 
               names_to = "measure", values_to = "n") %>%
  st_as_sf() %>%
  ggplot() +
    geom_sf(aes(fill = n)) +
    geom_sf_text(aes(label = round(n, 3))) +
    geom_sf(data = test_circles, fill = alpha("white", 0), 
            colour = "firebrick") +
    scale_fill_gradient2() +
    labs(fill = "number of occurrences", x = "", y = "") +
    facet_wrap(~measure, ncol = 2) +
    theme(legend.position = "bottom")
```

```{r}
full_join(grid_df, occupancy_prob_df, by = join_by(id)) %>%
  mutate(cat = case_when(
    p <= 0.25 ~ "0-0.25",
    p > 0.25 & p <= 0.5 ~ "0.25-0.5",
    p > 0.5 & p <= 0.75 ~ "0.5-0.75",
    TRUE ~ "0.75-1.0"
  )) %>%
  ggplot() +
  geom_sf(aes(fill = cat)) +
  geom_sf_text(aes(label = round(p, 3))) +
  geom_sf(data = test_circles, fill = alpha("white", 0), 
          colour = "firebrick") +
  labs(fill = "P(n >=1)", title = "Probability of occupancy",
       x = "", y = "")
```

# Convergence

```{r}
cum_mean_df <- final_df %>%
  group_by(id) %>%
  arrange(id, sim) %>%
  mutate(mean_n = cummean(n))

cum_mean_df %>%
  ggplot(aes(x = sim, y = mean_n, colour = as.factor(id), group = id)) +
    geom_line() +
    scale_x_continuous(breaks = seq(0, 1000, 100)) +
    theme(legend.position = "") +
    labs(x = "number of simulations", y = "mean number of\noccurrences per grid")
```

